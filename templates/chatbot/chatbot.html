{% extends 'base.html' %}
{% load static %}

{% block title %}Dr. Charaka AI - Medical Assistant{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h2>Dr. Charaka AI</h2>
        <p class="subtitle">Your Medical Assistant</p>
        <button id="clearChat" class="clear-button" title="Clear Chat History">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="message bot">
            <div class="message-content">
                <p>Namaste! I am Dr. Charaka AI, your medical assistant. I combine Ayurvedic wisdom with modern medicine to provide immediate medical guidance.</p>
                <p>Please describe your medical concern, and I will provide a professional assessment and recommendations.</p>
            </div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
    
    <form id="chatForm" class="chat-input-form">
        {% csrf_token %}
        <textarea 
            id="messageInput" 
            placeholder="Describe your health concern or ask a medical question..." 
            rows="1"
            required
        ></textarea>
        <button type="submit" id="sendButton">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>
</div>

<style>
.chat-container {
    max-width: 800px;
    margin: 20px auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    height: 80vh;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    text-align: center;
    background: #2c5aa0;
    color: white;
    border-radius: 10px 10px 0 0;
    position: relative;
}

.chat-header h2 {
    margin: 0;
    font-size: 24px;
}

.chat-header .subtitle {
    margin: 5px 0 0;
    font-size: 16px;
    opacity: 0.9;
}

.clear-button {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: 1px solid white;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.clear-button:hover {
    background: rgba(255, 255, 255, 0.1);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    max-width: 85%;
}

.message.user {
    margin-left: auto;
}

.message-content {
    padding: 15px;
    border-radius: 15px;
    display: inline-block;
    line-height: 1.5;
    white-space: pre-line;
}

.message-content p {
    margin: 0 0 10px 0;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.user .message-content {
    background: #2c5aa0;
    color: white;
}

.bot .message-content {
    background: white;
    color: #333;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message-meta {
    font-size: 0.8em;
    color: #666;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.meta-item {
    margin-right: 10px;
}

.section-header {
    font-weight: 600;
    color: #2c5aa0;
    margin: 10px 0 5px 0;
    font-size: 1.1em;
}

.chat-input-form {
    display: flex;
    padding: 20px;
    border-top: 1px solid #eee;
    gap: 10px;
    background: white;
}

textarea {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 20px;
    resize: none;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
}

textarea:focus {
    outline: none;
    border-color: #2c5aa0;
    box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
}

button {
    background: #2c5aa0;
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

button:hover {
    background: #1e3f6f;
    transform: scale(1.05);
}

button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.typing-indicator {
    padding: 10px 20px;
    display: flex;
    gap: 5px;
    background: #f8f9fa;
}

.dot {
    width: 8px;
    height: 8px;
    background: #2c5aa0;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
</style>

<script>
const welcomeMessage = `Namaste! I am Dr. Charaka AI, your medical assistant. I combine Ayurvedic wisdom with modern medicine to provide immediate medical guidance.

Please describe your medical concern, and I will provide a professional assessment and recommendations.`;

let sessionId = '{{ session_id }}';

function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatMessage(content) {
    const lines = content.split('\n');
    let formattedContent = '';
    
    for (let line of lines) {
        if (line.startsWith('ASSESSMENT:') || 
            line.startsWith('RECOMMENDATIONS:') || 
            line.startsWith('NOTE:')) {
            formattedContent += `<div class="section-header">${line}</div>`;
        } else {
            formattedContent += line + '\n';
        }
    }
    
    return formattedContent;
}

function addMessage(content, type) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = formatMessage(content);
    
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

document.getElementById('clearChat').addEventListener('click', async function() {
    if (!confirm('Are you sure you want to clear the chat history?')) {
        return;
    }

    try {
        const response = await fetch(`/chatbot/api/chat/${sessionId}/clear/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to clear chat');
        }

        const data = await response.json();
        
        // Update session ID
        sessionId = data.new_session_id;
        
        // Clear messages container
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
        
        // Add welcome message back
        addMessage(welcomeMessage, 'bot');
        
    } catch (error) {
        console.error('Error clearing chat:', error);
        alert('Failed to clear chat history. Please try again.');
    }
});

document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    messageInput.value = '';
    
    // Show typing indicator
    document.getElementById('typingIndicator').style.display = 'flex';
    
    try {
        const response = await fetch('/chatbot/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                message: message,
                session_id: sessionId
            }),
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Failed to get response');
        }
        
        const data = await response.json();
        
        // Update session ID if it's a new session
        if (data.session_id) {
            sessionId = data.session_id;
        }
        
        // Add bot response to chat
        addMessage(data.response, 'bot');
        
    } catch (error) {
        console.error('Error:', error);
        addMessage('I apologize, but I encountered an error. Please try again.', 'bot');
    } finally {
        // Hide typing indicator
        document.getElementById('typingIndicator').style.display = 'none';
    }
});

// Auto-resize textarea
const textarea = document.getElementById('messageInput');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});
</script>
{% endblock %}